<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡¨ç¤º</title>
  <style>
    table { border-collapse: collapse; }
    td, th {
      border: 1px solid #aaa;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    button {
      padding: 4px 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .selected {
      background-color: #99ccff !important; /* é’è‰² */
    }
  </style>
</head>
<body>
  <h1>äºˆç´„è¡¨</h1>
  <p>ä»²è‰¯ãSEMã‚’ä½¿ã„ã¾ã—ã‚‡ã†ğŸ‘</p>
  <div id="sheetData">Loading...</div>

  <button id="reserveBtn" style="margin-top: 20px;">äºˆç´„</button>

  <script>
    const selectedCells = []; // é¸æŠã•ã‚ŒãŸã‚»ãƒ«æƒ…å ±ã‚’è¤‡æ•°ä¿å­˜
    fetch("https://script.google.com/macros/s/AKfycbw3qU5ozR2Wnza1f3wQoWmM3o8dHTEx6n6MhELjp52TH4Mt9Ousw6GCd_K9eRpJi3xP/exec")
  .then(res => res.json())
  .then(data => {
    const table = document.createElement("table");

    data.forEach((row, rowIndex) => {
      const tr = document.createElement("tr");

      row.forEach((cell, colIndex) => {
        const isHeader = rowIndex === 0 || colIndex === 0;
        const cellElement = document.createElement(isHeader ? "th" : "td");

        if (!isHeader) {
          if (cell === "") {
            const button = document.createElement("button");
            button.textContent = "â—‹";

            button.addEventListener("click", () => {
              const isSelected = cellElement.classList.toggle("selected");

              if (isSelected) {
                button.textContent = "âœ“";
                selectedCells.push({
                  date: data[0][colIndex],
                  time: data[rowIndex][0],
                  cell: cellElement,
                  button: button,
                  row: rowIndex,  // rowç•ªå·ã‚’è¿½åŠ 
                  col: colIndex   // colç•ªå·ã‚’è¿½åŠ 
                });
              } else {
                button.textContent = "â—‹";
                // é¸æŠè§£é™¤æ™‚ã€é…åˆ—ã‹ã‚‰å‰Šé™¤
                const index = selectedCells.findIndex(
                  item => item.cell === cellElement
                );
                if (index !== -1) selectedCells.splice(index, 1);
              }
            });

            cellElement.appendChild(button);
            cellElement.style.backgroundColor = "#ccffcc"; // é»„ç·‘
          } else if (cell === "Ã—") {
            cellElement.textContent = cell;
            cellElement.style.backgroundColor = "#ddd"; // ç°è‰²
          } else {
            cellElement.textContent = cell;
            cellElement.style.backgroundColor = "#ffcccc"; // èµ¤
          }
        } else {
          cellElement.textContent = cell;
        }

        tr.appendChild(cellElement);
      });

      table.appendChild(tr);
    });

    document.getElementById("sheetData").innerHTML = "";
    document.getElementById("sheetData").appendChild(table);
  })
  .catch(err => {
    document.getElementById("sheetData").textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + err;
  });

  // äºˆç´„ãƒœã‚¿ãƒ³ã®å‡¦ç†
  document.getElementById("reserveBtn").addEventListener("click", () => {
    if (selectedCells.length > 0) {
      const name = prompt("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
      if (!name) {
        alert("åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã€‚");
        return;
      }

      const message = selectedCells.map(item => `${item.date} ${item.time}`).join('\n');
      const confirmMsg = `ä»¥ä¸‹ã®æ™‚é–“ã§äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ\n\n${message}\n\nåå‰ï¼š${name}`;
      const confirmed = confirm(confirmMsg);
/*
      if (confirmed) {
        // GASã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        const payload = selectedCells.map(item => ({
          row: item.row,  // rowç•ªå·
          col: item.col,  // colç•ªå·
          name: name
        }));

        // POSTã§GASã«é€ä¿¡
        fetch('https://script.google.com/macros/s/AKfycbwfI_w5TaH7Gt0zp6O2w7aj3IchH5V7c-aWdHjesxd2UJkN30XqTiV4fSxL7fdxTasBeg/exec', {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.text())
        .then(responseText => {
          alert("äºˆç´„ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼");
        })
        .catch(error => {
          alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error);
        });
      } else {
        alert("äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
      }
    } else {
      alert("äºˆç´„ã—ãŸã„æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }
    */
  });
