<script>
  let selectedStart = null; // ← 最初の1マスだけ保持
  function loadSheet() {
    selectedStart = null;
    document.getElementById("sheetData").textContent = "Loading...";

    fetch("https://script.google.com/macros/s/AKfycbw4vZYPeZHlEBAC191AX5O4wzITi9Hrln7qnmsDrTl4pqwF6uob93WCtSk7Sto4VnZaRw/exec")
      .then(res => res.json())
      .then(data => {
        const table = document.createElement("table");

        data.forEach((row, rowIndex) => {
          const tr = document.createElement("tr");

          row.forEach((cell, colIndex) => {
            const isHeader = rowIndex === 0 || colIndex === 0;
            const cellElement = document.createElement(isHeader ? "th" : "td");

            if (!isHeader) {
              if (cell === "") {
                const button = document.createElement("button");
                button.textContent = "○";

                button.addEventListener("click", () => {
                  // クリックは1つだけ
                  if (selectedStart && selectedStart.cell !== cellElement) {
                    selectedStart.button.textContent = "○";
                    selectedStart.cell.classList.remove("selected");
                  }

                  const isSelected = cellElement.classList.toggle("selected");
                  if (isSelected) {
                    button.textContent = "✓";
                    selectedStart = {
                      date: data[0][colIndex],
                      time: data[rowIndex][0],
                      cell: cellElement,
                      button: button,
                      rowIndex: rowIndex,
                      colIndex: colIndex
                    };
                  } else {
                    button.textContent = "○";
                    selectedStart = null;
                  }
                });

                cellElement.appendChild(button);
                cellElement.style.backgroundColor = "#ccffcc";
              } else if (cell === "×") {
                cellElement.textContent = cell;
                cellElement.style.backgroundColor = "#ddd";
              } else {
                cellElement.textContent = cell;
                cellElement.style.backgroundColor = "#ffcccc";
              }
            } else {
              cellElement.textContent = cell;
            }

            tr.appendChild(cellElement);
          });

          table.appendChild(tr);
        });

        const container = document.getElementById("sheetData");
        container.innerHTML = "";
        container.appendChild(table);
      })
      .catch(err => {
        document.getElementById("sheetData").textContent = "エラー：" + err;
      });
  }

  window.addEventListener("DOMContentLoaded", loadSheet);

  // 名前「その他」処理
  document.getElementById("nameSelect").addEventListener("change", () => {
    const selected = document.getElementById("nameSelect").value;
    const otherInput = document.getElementById("otherName");
    if (selected === "その他") {
      otherInput.style.display = "inline-block";
    } else {
      otherInput.style.display = "none";
      otherInput.value = "";
    }
  });

  document.getElementById("reserveBtn").addEventListener("click", () => {
    let name = document.getElementById("nameSelect").value;
    if (name === "その他") {
      name = document.getElementById("otherName").value.trim();
    }
    if (!name) {
      alert("名前が入力されていません。");
      return;
    }

    if (!selectedStart) {
      alert("開始時間を選択してください。");
      return;
    }

    // 追加：何時間か？
    const hours = prompt("何時間予約しますか？（数値）", "1");
    if (!hours || isNaN(hours) || hours <= 0) {
      alert("時間数が正しく入力されていません。");
      return;
    }

    const confirmMsg =
      `以下の内容で予約しますか？\n\n` +
      `名前：${name}\n` +
      `開始：${selectedStart.date} ${selectedStart.time}\n` +
      `時間：${hours} 時間\n`;

    if (!confirm(confirmMsg)) return;

    sendData(name, selectedStart.rowIndex, selectedStart.colIndex, hours);
    alert("予約しました。更新して確認してください。");
    loadSheet();
  });

  function sendData(inputText, row, col, hours) {
    const url =
      "https://script.google.com/macros/s/AKfycbyp90PE1fdXlCea2I2TcheUXAcEHwFA_yI8o031IMyjRMH2mxrNk-YVVZf889fPXoBvoQ/exec";

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body:
        `inputText=${encodeURIComponent(inputText)}` +
        `&row=${encodeURIComponent(row)}` +
        `&col=${encodeURIComponent(col)}` +
        `&hours=${encodeURIComponent(hours)}`
    })
      .then(res => res.text())
      .then(() => {})
      .catch(error => {
        alert("エラーが発生しました: " + error);
      });
  }
</script>
